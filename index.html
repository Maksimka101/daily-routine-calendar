<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daily Routine Calendar</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Кастомная конфигурация Tailwind */
    @layer base {
      body {
        font-feature-settings: 'tnum';
      }
    }

    /* Тонкие линии древовидной структуры */
    .trunk-line {
      stroke: #d6d3d1;
      stroke-width: 1.5;
      fill: none;
    }

    .branch-line {
      stroke: #d6d3d1;
      stroke-width: 1;
      fill: none;
    }

    /* Красная линия текущего времени */
    .current-time-indicator {
      background: linear-gradient(to right, transparent, #ef4444 20%, #ef4444 80%, transparent);
    }

    /* Tabular nums для времени */
    .time-display {
      font-variant-numeric: tabular-nums;
    }

    /* Hover effect для кнопок header */
    .header-btn {
      position: relative;
      border-radius: 0.25rem;
    }

    .header-btn::before {
      content: '';
      position: absolute;
      inset: 0;
      background-color: #f5f5f4;
      border-radius: 0.25rem;
      opacity: 0;
      transition: opacity 150ms ease;
      z-index: -1;
    }

    .header-btn:hover::before {
      opacity: 1;
    }

    .header-btn:hover {
      color: #57534e;
    }
  </style>
</head>

<body class="bg-white min-h-screen">
  <div id="app">
    <!-- Header Component -->
    <app-header :schedules="schedules" :active-schedule-index="activeScheduleIndex" :active-schedule="activeSchedule"
      @update:active-schedule-index="activeScheduleIndex = $event" @create-schedule="handleCreateSchedule"
      @delete-schedule="handleDeleteSchedule" @update-schedule="handleUpdateSchedule"></app-header>

    <!-- Calendar Body Component -->
    <calendar-body :marks="marks" :current-time="currentTime"></calendar-body>

    <footer class="max-w-3xl mx-auto px-8 py-6">
      <div class="text-[12px] text-stone-400 leading-relaxed pl-2.5 pr-2 mt-2 line-clamp-3 break-words">
        Сделано с любовью Максимом Земляникиным для Максима Земляникина и всего человечества
      </div>
    </footer>
  </div>

  <script type="module">
    import { ScheduleService } from './src/services/ScheduleService.js';
    import { MarkService } from './src/services/MarkService.js';
    import AppHeader from './src/components/AppHeader.js';
    import CalendarBody from './src/components/CalendarBody.js';

    const { createApp, ref, computed, onMounted, onUnmounted } = Vue;

    createApp({
      components: {
        AppHeader,
        CalendarBody
      },

      setup() {
        // Сервисы
        const scheduleService = new ScheduleService();
        const markService = new MarkService();

        // Состояние
        const schedules = ref([]);
        const activeScheduleIndex = ref(0);
        const marks = ref([]);
        const currentTime = ref(new Date());

        // Computed
        const activeSchedule = computed(() => {
          return schedules.value[activeScheduleIndex.value] || null;
        });

        // Methods
        function loadData() {
          // Загружаем расписания
          const loadedSchedules = scheduleService.getSchedules();

          // Если нет расписаний, создаём дефолтное
          if (loadedSchedules.length === 0) {
            const defaultSchedule = scheduleService.createSchedule(
              'Обычный день',
              '07:00',
              '22:00'
            );
            schedules.value = [defaultSchedule];
          } else {
            schedules.value = loadedSchedules;
          }

          // Загружаем засечки для активного расписания
          if (activeSchedule.value) {
            marks.value = markService.getMarks(activeSchedule.value.id);
          }
        }

        function startTimeUpdates() {
          // Обновляем текущее время каждую минуту
          const interval = setInterval(() => {
            currentTime.value = new Date();
          }, 60000);

          onUnmounted(() => {
            clearInterval(interval);
          });
        }

        function handleUpdateSchedule(data) {
          if (!activeSchedule.value) return;
          const updated = scheduleService.updateSchedule(activeSchedule.value.id, data);
          const index = activeScheduleIndex.value;
          schedules.value = schedules.value.map((s, i) => (i === index ? updated : s));
          // Засечки пересчитываются в сервисе (shiftDefaultMarks), перезагружаем
          marks.value = markService.getMarks(updated.id);
        }

        function handleCreateSchedule(name) {
          // Копируем время из текущей активной вкладки
          const currentSchedule = activeSchedule.value;
          const wakeTime = currentSchedule?.wakeTime || '07:00';
          const bedtime = currentSchedule?.bedtime || '22:00';

          // Создаём новое расписание
          const newSchedule = scheduleService.createSchedule(name, wakeTime, bedtime);
          schedules.value.push(newSchedule);

          // Переключаемся на новую вкладку
          activeScheduleIndex.value = schedules.value.length - 1;

          console.log('✓ Создано новое расписание:', name);
        }

        function handleDeleteSchedule(index) {
          const scheduleToDelete = schedules.value[index];

          // Удаляем расписание (также удалит все связанные засечки)
          scheduleService.deleteSchedule(scheduleToDelete.id);
          schedules.value.splice(index, 1);

          // Если удалили последнее — создаём новое дефолтное расписание
          if (schedules.value.length === 0) {
            const defaultSchedule = scheduleService.createSchedule(
              'Обычный день',
              '07:00',
              '22:00'
            );
            schedules.value.push(defaultSchedule);
            activeScheduleIndex.value = 0;
            marks.value = markService.getMarks(defaultSchedule.id);
            console.log('✓ Создано дефолтное расписание');
          } else {
            // Переключаемся на соседнюю вкладку
            if (activeScheduleIndex.value >= schedules.value.length) {
              activeScheduleIndex.value = schedules.value.length - 1;
            } else if (activeScheduleIndex.value > index) {
              activeScheduleIndex.value--;
            }
            if (activeSchedule.value) {
              marks.value = markService.getMarks(activeSchedule.value.id);
            }
            console.log('✓ Удалено расписание:', scheduleToDelete.name);
          }
        }

        // Lifecycle
        onMounted(() => {
          loadData();
          startTimeUpdates();
        });

        // Watch для смены расписания
        Vue.watch(activeScheduleIndex, () => {
          if (activeSchedule.value) {
            marks.value = markService.getMarks(activeSchedule.value.id);
          }
        });

        return {
          schedules,
          activeScheduleIndex,
          activeSchedule,
          marks,
          currentTime,
          handleCreateSchedule,
          handleDeleteSchedule,
          handleUpdateSchedule
        };
      }
    }).mount('#app');
  </script>
</body>

</html>
