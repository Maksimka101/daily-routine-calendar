<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daily Routine Calendar</title>
  <link rel="stylesheet" href="./src/styles/main.css">
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>

<body class="page">
  <div id="app">
    <app-header :schedules="schedules" :active-schedule-index="activeScheduleIndex" :active-schedule="activeSchedule"
      @update:active-schedule-index="activeScheduleIndex = $event" @create-schedule="handleCreateSchedule"
      @delete-schedule="handleDeleteSchedule" @update-schedule="handleUpdateSchedule"></app-header>

    <calendar-body :marks="marks" :current-time="currentTime"></calendar-body>

    <footer class="container footer">
      <div class="footer__text">
        Сделано с любовью Максимом Земляникиным для Максима Земляникина и всего человечества
      </div>
    </footer>
  </div>

  <script type="module">
    /**
     * @fileoverview Точка входа приложения: Vue 3 app с расписаниями и засечками
     */
    import { ScheduleService } from './src/services/ScheduleService.js';
    import { MarkService } from './src/services/MarkService.js';
    import AppHeader from './src/components/AppHeader.js';
    import CalendarBody from './src/components/CalendarBody.js';

    const { createApp, ref, computed, onMounted, onUnmounted } = Vue;

    createApp({
      components: {
        AppHeader,
        CalendarBody
      },

      /**
       * Composition API setup: состояние, сервисы, обработчики и lifecycle.
       * @returns {Object} Реактивные данные и методы для шаблона
       */
      setup() {
        const scheduleService = new ScheduleService();
        const markService = new MarkService();

        const schedules = ref([]);
        const activeScheduleIndex = ref(0);
        const marks = ref([]);
        const currentTime = ref(new Date());

        /** @type {import('vue').ComputedRef<import('./src/repositories/ScheduleRepository.js').Schedule|null>} */
        const activeSchedule = computed(() => {
          return schedules.value[activeScheduleIndex.value] || null;
        });

        /**
         * Загружает расписания из сервиса; при пустом списке создаёт дефолтное "Обычный день".
         * Загружает засечки для текущего активного расписания.
         */
        function loadData() {
          const loadedSchedules = scheduleService.getSchedules();

          if (loadedSchedules.length === 0) {
            const defaultSchedule = scheduleService.createSchedule(
              'Обычный день',
              '07:00',
              '22:00'
            );
            schedules.value = [defaultSchedule];
          } else {
            schedules.value = loadedSchedules;
          }

          if (activeSchedule.value) {
            marks.value = markService.getMarks(activeSchedule.value.id);
          }
        }

        /**
         * Запускает обновление currentTime каждую минуту; при размонтировании очищает interval.
         */
        function startTimeUpdates() {
          const interval = setInterval(() => {
            currentTime.value = new Date();
          }, 60000);

          onUnmounted(() => {
            clearInterval(interval);
          });
        }

        /**
         * Обновляет активное расписание (имя, wakeTime, bedtime) и перезагружает засечки.
         * @param {{ name?: string, wakeTime?: string, bedtime?: string }} data - Поля для обновления
         */
        function handleUpdateSchedule(data) {
          if (!activeSchedule.value) return;
          const updated = scheduleService.updateSchedule(activeSchedule.value.id, data);
          const index = activeScheduleIndex.value;
          schedules.value = schedules.value.map((s, i) => (i === index ? updated : s));
          // shiftDefaultMarks уже выполнен в сервисе — перезагружаем засечки
          marks.value = markService.getMarks(updated.id);
        }

        /**
         * Создаёт новое расписание с заданным именем, копируя wakeTime и bedtime из текущей вкладки.
         * Переключает активную вкладку на новую.
         * @param {string} name - Название нового расписания
         */
        function handleCreateSchedule(name) {
          const currentSchedule = activeSchedule.value;
          const wakeTime = currentSchedule?.wakeTime || '07:00';
          const bedtime = currentSchedule?.bedtime || '22:00';

          const newSchedule = scheduleService.createSchedule(name, wakeTime, bedtime);
          schedules.value.push(newSchedule);
          activeScheduleIndex.value = schedules.value.length - 1;

          console.log('✓ Создано новое расписание:', name);
        }

        /**
         * Удаляет расписание по индексу; при удалении последнего создаёт дефолтное "Обычный день".
         * Переключает активную вкладку на соседнюю при необходимости.
         * @param {number} index - Индекс удаляемого расписания в списке
         */
        function handleDeleteSchedule(index) {
          const scheduleToDelete = schedules.value[index];

          scheduleService.deleteSchedule(scheduleToDelete.id);
          schedules.value.splice(index, 1);

          if (schedules.value.length === 0) {
            const defaultSchedule = scheduleService.createSchedule(
              'Обычный день',
              '07:00',
              '22:00'
            );
            schedules.value.push(defaultSchedule);
            activeScheduleIndex.value = 0;
            marks.value = markService.getMarks(defaultSchedule.id);
            console.log('✓ Создано дефолтное расписание');
          } else {
            if (activeScheduleIndex.value >= schedules.value.length) {
              activeScheduleIndex.value = schedules.value.length - 1;
            } else if (activeScheduleIndex.value > index) {
              activeScheduleIndex.value--;
            }
            if (activeSchedule.value) {
              marks.value = markService.getMarks(activeSchedule.value.id);
            }
            console.log('✓ Удалено расписание:', scheduleToDelete.name);
          }
        }

        onMounted(() => {
          loadData();
          startTimeUpdates();
        });

        Vue.watch(activeScheduleIndex, () => {
          if (activeSchedule.value) {
            marks.value = markService.getMarks(activeSchedule.value.id);
          }
        });

        return {
          schedules,
          activeScheduleIndex,
          activeSchedule,
          marks,
          currentTime,
          handleCreateSchedule,
          handleDeleteSchedule,
          handleUpdateSchedule
        };
      }
    }).mount('#app');
  </script>
</body>

</html>
