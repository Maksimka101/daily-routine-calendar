<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daily Routine Calendar</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* –ö–∞—Å—Ç–æ–º–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Tailwind */
    @layer base {
      body {
        font-feature-settings: 'tnum';
      }
    }

    /* –¢–æ–Ω–∫–∏–µ –ª–∏–Ω–∏–∏ –¥—Ä–µ–≤–æ–≤–∏–¥–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã */
    .trunk-line {
      stroke: #d6d3d1;
      stroke-width: 1.5;
      fill: none;
    }

    .branch-line {
      stroke: #d6d3d1;
      stroke-width: 1;
      fill: none;
    }

    /* –ö—Ä–∞—Å–Ω–∞—è –ª–∏–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ */
    .current-time-indicator {
      background: linear-gradient(to right, transparent, #ef4444 20%, #ef4444 80%, transparent);
    }

    /* Tabular nums –¥–ª—è –≤—Ä–µ–º–µ–Ω–∏ */
    .time-display {
      font-variant-numeric: tabular-nums;
    }
  </style>
</head>

<body class="bg-white min-h-screen">
  <div id="app">
    <!-- –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π Header -->
    <header class="border-b border-stone-200">
      <div class="max-w-3xl mx-auto px-8 py-3 flex justify-between items-center">
        <!-- –í–∫–ª–∞–¥–∫–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π -->
        <div class="flex gap-1">
          <button v-for="(schedule, index) in schedules" :key="schedule.id" @click="activeScheduleIndex = index" :class="[
              'px-3 py-1 text-[13px] font-medium transition-colors duration-150',
              activeScheduleIndex === index
                ? 'text-stone-700'
                : 'text-stone-400 hover:text-stone-600'
            ]">
            {{ schedule.name }}
          </button>
        </div>

        <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ —Å–Ω–∞ -->
        <div class="flex gap-6 items-center text-[13px] text-stone-600">
          <div class="flex items-center gap-1.5">
            <span class="text-base">üåô</span>
            <span class="time-display">{{ activeSchedule?.bedtime }}</span>
          </div>
          <div class="flex items-center gap-1.5">
            <span class="text-base">‚òÄÔ∏è</span>
            <span class="time-display">{{ activeSchedule?.wakeTime }}</span>
          </div>
          <!-- Debug –∫–Ω–æ–ø–∫–∞ -->
          <button @click="regenerateMarks"
            class="px-2 py-1 text-[11px] text-stone-400 hover:text-stone-600 hover:bg-stone-50 rounded transition-colors"
            title="–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∑–∞—Å–µ—á–∫–∏">
            ‚Üª Debug
          </button>
        </div>
      </div>
    </header>

    <!-- –î—Ä–µ–≤–æ–≤–∏–¥–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ -->
    <main class="max-w-3xl mx-auto px-8 py-12">
      <div class="relative" :style="{ minHeight: svgHeight + 'px' }">
        <!-- SVG –¥–ª—è —Å—Ç–≤–æ–ª–∞ –∏ –≤–µ—Ç–æ–∫ -->
        <svg class="absolute inset-0 w-full pointer-events-none" :style="{ height: svgHeight + 'px' }"
          style="z-index: 1;">
          <!-- –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å—Ç–≤–æ–ª -->
          <line class="trunk-line" x1="50%" y1="0" x2="50%" :y2="svgHeight" />

          <!-- –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –≤–µ—Ç–∫–∏ -->
          <line v-for="(mark, index) in sortedMarks" :key="mark.id" class="branch-line"
            :x1="index % 2 === 0 ? '50%' : '8%'" :y1="getMarkYPosition(index)" :x2="index % 2 === 0 ? '92%' : '50%'"
            :y2="getMarkYPosition(index)" />
        </svg>

        <!-- –ö—Ä–∞—Å–Ω–∞—è –ª–∏–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ (–ø–æ–¥ –¥–µ—Ä–µ–≤–æ–º) -->
        <div v-if="currentTimeYPosition !== null"
          class="absolute left-0 right-0 h-px current-time-indicator pointer-events-none"
          :style="{ top: (currentTimeYPosition - 0.5) + 'px', zIndex: 0 }">
        </div>

        <!-- –¢–æ—á–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ (–Ω–∞–¥ –¥–µ—Ä–µ–≤–æ–º) -->
        <div v-if="currentTimeYPosition !== null"
          class="absolute left-1/2 -translate-x-1/2 -translate-y-1/2 pointer-events-none"
          :style="{ top: currentTimeYPosition + 'px', zIndex: 3 }">
          <!-- –¢–æ—á–∫–∞ –Ω–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–∏ —Å–æ —Å—Ç–≤–æ–ª–æ–º -->
          <div class="w-2 h-2 bg-red-500 rounded-full shadow-[0_0_8px_rgba(239,68,68,0.5)]">
          </div>
        </div>

        <!-- –ó–∞—Å–µ—á–∫–∏ -->
        <div class="relative" style="z-index: 2;">
          <div v-for="(mark, index) in sortedMarks" :key="mark.id" :class="[
              'absolute w-[37%]',
              index % 2 === 0 ? 'right-[9.5%]' : 'left-[9.5%]'
            ]" :style="{ top: (getMarkYPosition(index) - 25) + 'px' }">
            <!-- –ù–ê–î –ª–∏–Ω–∏–µ–π: emoji + –≤—Ä–µ–º—è + –Ω–∞–∑–≤–∞–Ω–∏–µ -->
            <div class="flex items-center gap-2 mb-2 min-w-0 px-2">
              <span class="text-[18px] leading-none flex-shrink-0">{{ mark.emoji }}</span>
              <span class="text-[12px] text-stone-400 time-display leading-none flex-shrink-0">{{ mark.time }}</span>
              <span class="text-[14px] text-stone-600 font-medium leading-tight truncate min-w-0">{{ mark.title
                }}</span>
            </div>

            <!-- –ü–û–î –ª–∏–Ω–∏–µ–π: –æ–ø–∏—Å–∞–Ω–∏–µ -->
            <div v-if="mark.description"
              class="text-[12px] text-stone-400 leading-relaxed pl-2.5 pr-2 mt-2 line-clamp-3 break-words">
              {{ mark.description }}
            </div>
          </div>
        </div>
      </div>
    </main>

    <footer class="max-w-3xl mx-auto px-8 py-6">
      <div class="text-[12px] text-stone-400 leading-relaxed pl-2.5 pr-2 mt-2 line-clamp-3 break-words">
        –°–¥–µ–ª–∞–Ω–æ —Å –ª—é–±–æ–≤—å—é –ú–∞–∫—Å–∏–º–æ–º –ó–µ–º–ª—è–Ω–∏–∫–∏–Ω—ã–º –¥–ª—è –ú–∞–∫—Å–∏–º–∞ –ó–µ–º–ª—è–Ω–∏–∫–∏–Ω–∞ –∏ –≤—Å–µ–≥–æ —á–µ–ª–æ–≤–µ—á–µ—Å—Ç–≤–∞
      </div>
    </footer>
  </div>

  <script type="module">
    import { ScheduleService } from './src/services/ScheduleService.js';
    import { MarkService } from './src/services/MarkService.js';

    const { createApp, ref, computed, onMounted, onUnmounted } = Vue;

    createApp({
      setup() {
        // –°–µ—Ä–≤–∏—Å—ã
        const scheduleService = new ScheduleService();
        const markService = new MarkService();

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ
        const schedules = ref([]);
        const activeScheduleIndex = ref(0);
        const marks = ref([]);
        const currentTime = ref(new Date());

        // Computed
        const activeSchedule = computed(() => {
          return schedules.value[activeScheduleIndex.value] || null;
        });

        const sortedMarks = computed(() => {
          return [...marks.value].sort((a, b) => {
            const timeA = timeToMinutes(a.time);
            const timeB = timeToMinutes(b.time);
            return timeA - timeB;
          });
        });

        // –ú–∞—Å—à—Ç–∞–±: –ø–∏–∫—Å–µ–ª–µ–π –Ω–∞ —á–∞—Å (—É–º–µ–Ω—å—à–µ–Ω –¥–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ—Å—Ç–∏)
        const pixelsPerHour = 60;

        // –í—Ä–µ–º–µ–Ω–Ω–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        const timeRange = computed(() => {
          if (!sortedMarks.value.length) return { start: 0, end: 1440 };

          const firstMarkTime = timeToMinutes(sortedMarks.value[0].time);
          const lastMarkTime = timeToMinutes(sortedMarks.value[sortedMarks.value.length - 1].time);

          // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ 30 –º–∏–Ω—É—Ç –≤ –Ω–∞—á–∞–ª–µ –∏ –∫–æ–Ω—Ü–µ
          return {
            start: Math.max(0, firstMarkTime - 30),
            end: Math.min(1440, lastMarkTime + 30)
          };
        });

        const svgHeight = computed(() => {
          const range = timeRange.value.end - timeRange.value.start;
          const hours = range / 60;
          return hours * pixelsPerHour + 100;
        });

        const currentTimeLabel = computed(() => {
          const h = String(currentTime.value.getHours()).padStart(2, '0');
          const m = String(currentTime.value.getMinutes()).padStart(2, '0');
          return `${h}:${m}`;
        });

        const currentTimeYPosition = computed(() => {
          if (!sortedMarks.value.length) return null;

          const now = currentTime.value.getHours() * 60 + currentTime.value.getMinutes();
          const startTime = timeRange.value.start;
          const endTime = timeRange.value.end;

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–ø–∞–¥–∞–µ—Ç –ª–∏ —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ –¥–∏–∞–ø–∞–∑–æ–Ω
          if (now < startTime || now > endTime) return null;

          // –í—ã—á–∏—Å–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –≤—Ä–µ–º–µ–Ω–∏
          const minutesFromStart = now - startTime;
          const hoursFromStart = minutesFromStart / 60;

          return hoursFromStart * pixelsPerHour + 50;
        });

        // Methods
        function getMarkYPosition(index) {
          const mark = sortedMarks.value[index];
          if (!mark) return 50;

          const markTime = timeToMinutes(mark.time);
          const startTime = timeRange.value.start;

          // –í—ã—á–∏—Å–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –≤—Ä–µ–º–µ–Ω–∏
          const minutesFromStart = markTime - startTime;
          const hoursFromStart = minutesFromStart / 60;

          return hoursFromStart * pixelsPerHour + 50;
        }

        function timeToMinutes(time) {
          if (!time) return 0;
          const [h, m] = time.split(':').map(Number);
          return h * 60 + m;
        }

        function loadData() {
          // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
          const loadedSchedules = scheduleService.getSchedules();

          // –ï—Å–ª–∏ –Ω–µ—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π, —Å–æ–∑–¥–∞—ë–º –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ
          if (loadedSchedules.length === 0) {
            const defaultSchedule = scheduleService.createSchedule(
              '–û–±—ã—á–Ω—ã–π –¥–µ–Ω—å',
              '07:00',
              '22:00'
            );
            schedules.value = [defaultSchedule];
          } else {
            schedules.value = loadedSchedules;
          }

          // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞—Å–µ—á–∫–∏ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
          if (activeSchedule.value) {
            marks.value = markService.getMarks(activeSchedule.value.id);
          }
        }

        function startTimeUpdates() {
          // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
          const interval = setInterval(() => {
            currentTime.value = new Date();
          }, 60000);

          onUnmounted(() => {
            clearInterval(interval);
          });
        }

        // Lifecycle
        onMounted(() => {
          loadData();
          startTimeUpdates();
        });

        // Watch –¥–ª—è —Å–º–µ–Ω—ã —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
        Vue.watch(activeScheduleIndex, () => {
          if (activeSchedule.value) {
            marks.value = markService.getMarks(activeSchedule.value.id);
          }
        });

        // Debug: –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞—Å–µ—á–µ–∫
        function regenerateMarks() {
          if (!activeSchedule.value) return;

          // –£–¥–∞–ª—è–µ–º –≤—Å–µ –∑–∞—Å–µ—á–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
          const currentMarks = markService.getMarks(activeSchedule.value.id);
          currentMarks.forEach(mark => {
            markService.deleteMark(mark.id);
          });

          // –°–æ–∑–¥–∞—ë–º –∑–∞–Ω–æ–≤–æ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–∞—Å–µ—á–∫–∏
          markService.createDefaultMarks(
            activeSchedule.value.id,
            activeSchedule.value.wakeTime,
            activeSchedule.value.bedtime
          );

          // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º
          marks.value = markService.getMarks(activeSchedule.value.id);

          console.log('‚úì –ó–∞—Å–µ—á–∫–∏ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã');
        }

        return {
          schedules,
          activeScheduleIndex,
          activeSchedule,
          sortedMarks,
          svgHeight,
          currentTimeLabel,
          currentTimeYPosition,
          getMarkYPosition,
          regenerateMarks
        };
      }
    }).mount('#app');
  </script>
</body>

</html>
